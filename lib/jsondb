#!/usr/bin/env node

var async = require('async'),
	fs = require('fs'),
	events = require('events'),
	util = require('util'),
	flags = {
		CONNECTING: null,
		DELETING_DB: null
	}

/**
 * database class
 */
var DB = function jsondb(){

	events.EventEmitter.call(this)
	var self = this

	//@public
	this.dbname = null
	this.database = null
	this.storage = '.'
	this.handle = null

	//@public close connection
	this.close = function(fn){

		this.dbname = null
		this.database = null
		this.storage = '.'
		this.handle = null
		if(fn)
			fn()
		return this
	}

	//@public connect to database
	this.connect = function(dbname, fn){

		flags.CONNECTING = true
		self.dbname = dbname
		self.database = getDBLocation(this.dbname)
		var _db = self.database
		var _dbname = dbname

		//check database file
		var exists = fs.existsSync(_db)

		if(!exists){
						
			var json = {
				dbname: _dbname,
				tables: {}
			}
			var str = JSON.stringify(json, null, 4)
			fs.writeFileSync(_db, str)

		}
		if(fn){
			fn()
		}
		return this
	}

	//@public create a table
	this.create = function(what, tblname, fn){

		var json = this.getJSON()

		switch(what){

			case 'field':
				if(json.tables[tblname.table].fields.indexOf(tblname.field)>=0)
					return this
				else
					json.tables[tblname.table].fields.push(tblname.field)
				break;

			case 'table':
				json.tables[tblname] = {fields: [], data: []}
				break;
		}

		this.setJSON(json, fn)
		return this
	}

	this.delete_db = function(dbname, fn){

		var cb = fn,
			self = this
			_db = getDBLocation(dbname)

		flags.DELETING_DB = true

		//setup database filename
		this.database = _db

		fs.exists(this.database, function(exists){

			var _self = self
				_cb = cb
				_dbname = dbname

			if(exists){
				fs.unlink(_db, function(err){
					if(err)
						throw new Error(err)

					if(_self.dbname==_dbname)
						_self.close()

					if(_cb)
						_cb()
				})
			}
			else
				if(_cb)
					_cb()
		})
	}

	this.delete_field = function(tblname, field, fn){

		var j = this.getJSON()
		var index = j.tables[tblname].fields.indexOf(field)

		delete j.tables[tblname].fields[index]
		this.setJSON(j, fn)

		return this
	}

	this.delete_table = function(tblname, fn){

		var j = this.getJSON()
		delete j.tables[tblname]
		this.setJSON(j, fn)
	}

	this.setStorage = function(path, fn){

		self.storage = path

		if(fn)
			fn()
		return this
	}

	this.update = function(tblname, data, fn){

		var j = this.getJSON()

		if(!j.tables[tblname])
			throw new Error('Unkown table: '+tblname)

		//if data is string, then add new field
		if(typeof(data)=='string')
			j.tables[tblname].fields.push(data)
		else
			//else add new row
			j.tables[tblname].push(data)
		this.setJSON(j, cb)

		if(fn)
			fn()
		return this
	}

	/**
	 * Handles all queries, does check for connection etc.
	 * @deprecated not in use in this version
	 */
	this.query = function(method){

		var _self = this
		var _method = method
		var _args = arguments

		//callback to see if db exists
		function queryCheck(ok){
			_self[method]( _args )
		}

		//check if connected
		if( method!="connect" )
			this.connected(queryCheck)
		queryCheck()
	}

	/**
	 * Check if connected, called by this.query
	 * @deprecated not in use in this version
	 * @private
	 */
	function connected(fn){
		var ok = true
		fn(ok)
	}

	/**
	 * Get the full path to the a database. Uses current storage
	 * @private
	 * @param  {string} dbname Required. Database name
	 * @return {string}        
	 */
	function getDBLocation(dbname){

		return process.cwd()+'/'+db.storage+'/'+dbname+'.json'
	}

	/**
	 * Get the current json object from database file
	 * @private
	 */
	this.getJSON = function(){
		return require(db.database)
	}

	function pushData(tblname, data){
	}
	
	this.setJSON = function(json, fn){

		var _json = JSON.stringify(json, null, 4)
		fs.writeFile(db.database, _json, {flag: 'w'}, fn)
	}

}
util.inherits(DB, events.EventEmitter)
var db = new DB()
var queue = []

/**
 * driver
 */
var driver = {

	close: function(fn){
		db.close(fn)
		//queue.push(db.close.bind(db, fn))
		return this
	},

	connect: function(dbname, fn){
		db.connect(dbname, fn)
		//queue.push(db.connect.bind(db, dbname, fn))
		return this
	},

	create: function(what, tblname, fn){

		db.create(what, tblname, fn)
		return this
	},

	delete: function(what, val, fn){

		switch(what){

			case 'database':
				db.delete_db(val, fn)
				break;

			case 'table':
				db.delete_table(val, fn)
				break;

			case 'field':
				db.delete_field(val.table, val.field, fn)
				break;
		}
	},
	
	getDB: function(){
		
		return db
	},

	update: function(tblname, data, fn){
		
		db.update(tblname, data, fn)
		return this
	},

	run: function(){
		
	    async.series(queue, function(err, results){
	    	if(err)
	    		throw new Error(err)
	    })

		return null
	},

	setStorage: function(path, fn){
		db.setStorage(path, fn)
		//queue.push(db.setStorage.bind(db, path, fn))
		return this
	}
}

module.exports = driver